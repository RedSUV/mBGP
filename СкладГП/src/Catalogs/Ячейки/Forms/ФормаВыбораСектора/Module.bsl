#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//ЗаполнитьСектор();
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПодключитьОбработчикОжидания("НачатьВыводКвадратиковНаФормуПослеОткрытия",0.5, ИСТИНА);
КонецПроцедуры

&НаКлиенте
Процедура ВнешнееСобытие(Источник, Событие, Данные)
	
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииПараметровЭкрана()
	ДанныеЭкрана = ПолучитьИнформациюЭкрановКлиента();
	Если ДанныеЭкрана[0].Ширина > ДанныеЭкрана[0].Высота Тогда
		ГоризонтальноеПоложениеЭкрана = Истина;
		ЭлементовПоГоризонтали = 6;
	Иначе
		ГоризонтальноеПоложениеЭкрана = Ложь;
		ЭлементовПоГоризонтали = 3;
	КонецЕсли;
	ШиринаЭкрана = ДанныеЭкрана[0].Ширина;
	НастроитьФорму();
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьСектор()
	ЭлементыКнопкой = ИСТИНА;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Ячейки.Ссылка КАК Ссылка,
	|	Ячейки.Наименование КАК Наименование,
	|	Ячейки.НомерВСекторе КАК НомерВСекторе,
	|	Ячейки.ЭтоГруппа КАК ЭтоГруппа
	|ИЗ
	|	Константа.Склад КАК КонстСклад
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Ячейки КАК Ячейки
	|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Ячейки.Ссылка) КАК КоличествоШтабелей,
	|				Ячейки.Родитель КАК Родитель
	|			ИЗ
	|				Справочник.Ячейки КАК Ячейки
	|			ГДЕ
	|				НЕ Ячейки.ПометкаУдаления
	|			
	|			СГРУППИРОВАТЬ ПО
	|				Ячейки.Родитель) КАК ВложенныйЗапрос
	|			ПО Ячейки.Ссылка = ВложенныйЗапрос.Родитель
	|		ПО КонстСклад.Значение = Ячейки.Владелец
	|ГДЕ
	|	Ячейки.ЭтоГруппа
	|	И НЕ Ячейки.ПометкаУдаления
	|	И ЕСТЬNULL(ВложенныйЗапрос.КоличествоШтабелей, 0) > 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерВСекторе,
	|	Наименование";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		СтрокаТаблицы = ТаблицаСекторов.Добавить();
		СтрокаТаблицы.Ссылка = Выборка.Ссылка;
		
		Если ЭлементыКнопкой Тогда
			ЭлементФормы = ЯчейкиСклада.ЭлементФормыСекторШтабельКнопка(ЭтотОбъект, Элементы, Неопределено, СтрокаТаблицы.Ссылка, НЕОПРЕДЕЛЕНО, СтрокаТаблицы);
		Иначе
			ЭлементФормы = ЯчейкиСклада.ЭлементФормыСекторШтабель(ЭтотОбъект, Элементы, Неопределено, СтрокаТаблицы.Ссылка, НЕОПРЕДЕЛЕНО, СтрокаТаблицы);
		КонецЕсли;
		Если ЭлементФормы = Неопределено Тогда
			Продолжить;
		КонецЕсли;
			
		СтрокаТаблицы.ИмяЭлементаФормы = ЭлементФормы.Имя;
	КонецЦикла;
	
	Если ТаблицаСекторов.Количество() > 0 Тогда
		ПерваяКнопка = Элементы[ТаблицаСекторов[0].ИмяЭлементаФормы];
		ЭтотОбъект.ТекущийЭлемент = ПерваяКнопка;
		ПерваяКнопка.АктивизироватьПоУмолчанию = ИСТИНА;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура НастроитьФорму(ЗаполнитьТаблицу = ЛОЖЬ)
	Если ЗаполнитьТаблицу Тогда
		ЗаполнитьСектор()
	КонецЕсли;
	ЯчейкиСклада.НастроитьФормуСектораШтабеляКвадратики(ЭтотОбъект, ТаблицаСекторов, ИСТИНА);
КонецПроцедуры

&НаКлиенте
Функция ПолучитьСтрокуОписанияЭлементаФормыНаКлиенте(ИмяЭлемента, ТаблицаОписания)
	СтрПакета = ТаблицаОписания.НайтиСтроки(Новый Структура("ИмяЭлементаФормы", ИмяЭлемента));
	Если СтрПакета.Количество() = 0 Тогда 
		Возврат Неопределено
	КонецЕсли;
	Возврат СтрПакета[0]
КонецФункции

&НаКлиенте
Процедура ДействиеПослеВыбораШтабеля(Результат, ДопПар) Экспорт
	Если ЗначениеЗаполнено(Результат) Тогда
		Закрыть(Результат);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура НачатьВыводКвадратиковНаФормуПослеОткрытия()
	ОпределитьПараметрыРазмещенияЭлементовПриИзмененииПараметровЭкрана();
	НастроитьФорму(ИСТИНА);	
КонецПроцедуры

&НаКлиенте
Процедура ОпределитьПараметрыРазмещенияЭлементовПриИзмененииПараметровЭкрана()
	ДанныеЭкрана = ПолучитьИнформациюЭкрановКлиента();
	Если ДанныеЭкрана[0].Ширина > ДанныеЭкрана[0].Высота Тогда
		ГоризонтальноеПоложениеЭкрана = Истина;
		ЭлементовПоГоризонтали = 6;	
	Иначе
		ГоризонтальноеПоложениеЭкрана = Ложь;
		ЭлементовПоГоризонтали = 3;
	КонецЕсли;
	ШиринаЭкрана = ДанныеЭкрана[0].Ширина;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура СекторШтабельНажатие(Элемент, СтандартнаяОбработка)

	СтрокаОписания = ПолучитьСтрокуОписанияЭлементаФормыНаКлиенте(Элемент.Имя, ТаблицаСекторов);	
	
	ДействиеПослеВыбораШтабеля = Новый ОписаниеОповещения("ДействиеПослеВыбораШтабеля", ЭтотОбъект);
	
	ОткрытьФорму("Справочник.Ячейки.Форма.ФормаВыбораШтабеляСектора", Новый Структура("Сектор", СтрокаОписания.Ссылка), ЭтотОбъект,,,,ДействиеПослеВыбораШтабеля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура СекторШтабельНажатиеКнопки(Команда)

	СтрокаОписания = ПолучитьСтрокуОписанияЭлементаФормыНаКлиенте(Команда.Имя, ТаблицаСекторов);	
	
	ДействиеПослеВыбораШтабеля = Новый ОписаниеОповещения("ДействиеПослеВыбораШтабеля", ЭтотОбъект);
	
	ОткрытьФорму("Справочник.Ячейки.Форма.ФормаВыбораШтабеляСектора", Новый Структура("Сектор", СтрокаОписания.Ссылка), ЭтотОбъект,,,,ДействиеПослеВыбораШтабеля, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаАктивизации(АктивныйОбъект, Источник)
	Сообщить(""+АктивныйОбъект);
КонецПроцедуры

#КонецОбласти
